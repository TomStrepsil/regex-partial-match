name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  release:
    name: Update Release Notes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.RELEASE_PAT || github.token }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check if it's a prerelease (contains -, like 1.0.0-beta.1)
          if [[ $VERSION == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate version matches package.json
        run: |
          TAG_VERSION=${{ steps.version.outputs.version }}
          PACKAGE_VERSION=$(jq -r '.version' package.json)

          echo "Tag version: $TAG_VERSION"
          echo "package.json version: $PACKAGE_VERSION"

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "❌ Error: Tag version ($TAG_VERSION) does not match package.json version ($PACKAGE_VERSION)"
            echo "Please ensure the tag matches the version in package.json"
            exit 1
          fi

          echo "✅ Version validation passed"

      - name: Update CHANGELOG with version and date
        id: update_changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DATE=$(date -u +"%Y-%m-%d")

          # Check if version already exists in changelog
          if grep -q "## \[${VERSION}\] - " docs/CHANGELOG.md; then
            echo "ℹ️ Version ${VERSION} already in CHANGELOG, skipping update"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            # Replace [Unreleased] with [VERSION] - DATE and add new [Unreleased] section
            sed -i "s/## \[Unreleased\]/## [Unreleased]\n\n## [${VERSION}] - ${DATE}/" docs/CHANGELOG.md
            echo "✅ Updated CHANGELOG.md with version ${VERSION} and date ${DATE}"
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit CHANGELOG changes
        if: steps.update_changelog.outputs.updated == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/CHANGELOG.md
          git diff --staged --quiet || git commit -m "docs: update CHANGELOG.md for v${{ steps.version.outputs.version }}"

          # Push using the authenticated remote that actions/checkout@v6 configured
          git push https://x-access-token:${{ secrets.RELEASE_PAT || github.token }}@github.com/${{ github.repository }}.git HEAD:main

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Extract the section for this version from docs/CHANGELOG.md
          # This assumes you follow "Keep a Changelog" format
          CHANGELOG_CONTENT=$(sed -n "/## \[${VERSION}\]/,/## \[/p" docs/CHANGELOG.md | sed '$d' | tail -n +2)

          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="Release version ${VERSION}"
          fi

          # Save to file to handle multiline content
          echo "$CHANGELOG_CONTENT" > release_notes.md

      - name: Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          prerelease: ${{ steps.version.outputs.prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

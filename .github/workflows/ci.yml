name: CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  changelog-and-semver-check:
    name: CHANGELOG and Semver Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check CHANGELOG for Unreleased entries
        run: |
          if ! grep -q "## \[Unreleased\]" docs/CHANGELOG.md; then
            echo "Error: docs/CHANGELOG.md must have an [Unreleased] section"
            exit 1
          fi

          # Extract content between [Unreleased] and the next version section or end of file
          # Match version sections starting with ## [ followed by a digit
          UNRELEASED_CONTENT=$(sed -n '/## \[Unreleased\]/,/^## \[[0-9]/p' docs/CHANGELOG.md)

          # Check if there are actual changes under [Unreleased]
          if ! echo "$UNRELEASED_CONTENT" | grep -q "^### "; then
            echo "Error: Please add an entry under [Unreleased] in docs/CHANGELOG.md"
            echo ""
            echo "Expected format (see https://keepachangelog.com/en/1.1.0/):"
            echo "## [Unreleased]"
            echo ""
            echo "### Added (or Changed, Deprecated, Removed, Fixed, Security)"
            echo "- Your change description"
            exit 1
          fi
          echo "✓ docs/CHANGELOG.md has entries under [Unreleased]"

      - name: Fetch latest PR body
        id: pr_body
        run: |
          gh pr view "$PR_URL" --json body -q ".body" > pr_body.txt
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ github.token }}

      - name: Check for semver selection
        run: |
          PR_BODY=$(cat pr_body.txt)
          echo "Checking PR description for semver selection..."

          # Count how many semver checkboxes are selected
          SELECTED_COUNT=$(echo "$PR_BODY" | grep -cE "\[x\] \*\*(MAJOR|MINOR|PATCH)\*\*" || true)

          if [ "$SELECTED_COUNT" -eq 0 ]; then
            echo "❌ Error: No semver checkbox selected in PR description"
            echo ""
            echo "Please select exactly ONE of the following in your PR description:"
            echo "  - [x] **PATCH** - Bug fixes and minor changes (backwards compatible)"
            echo "  - [x] **MINOR** - New features (backwards compatible)"
            echo "  - [x] **MAJOR** - Breaking changes (not backwards compatible)"
            echo ""
            echo "This is required for automated version management during releases."
            exit 1
          elif [ "$SELECTED_COUNT" -gt 1 ]; then
            echo "❌ Error: Multiple semver checkboxes selected ($SELECTED_COUNT found)"
            echo ""
            echo "Please select exactly ONE semver checkbox in your PR description."
            echo "Multiple selections create ambiguous version intent."
            echo ""
            echo "Current selections:"
            echo "$PR_BODY" | grep -E "\[x\] \*\*(MAJOR|MINOR|PATCH)\*\*"
            exit 1
          fi

          echo "✓ Exactly one semver checkbox selected"
